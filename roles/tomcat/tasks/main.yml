---
#- name: Install Java 1.7
#  apt: name=openjdk-11-jdk state=present
  
- name: Update APT package manager repositories cache
  apt:
        update_cache: yes
- name: Install Java using Ansible
  apt:
        name: openjdk-11-jdk
        state: present

#- name: add group "tomcat"
#   group: name={{tomcat_group}}

#- name: add user "tomcat"

#  user: name={{tomcat_user}} group={{tomcat_group}} home=/usr/share/tomcat createhome=no
#  become: True
#  become_method: sudo

#- name: Download Tomcat
#  get_url: url=http://archive.apache.org/dist/tomcat/tomcat-7/v7.0.61/bin/apache-tomcat-7.0.61.tar.gz dest=/opt/apache-tomcat-7.0.61.tar.gz

#- name: Extract archive
#  command: chdir=/usr/share /bin/tar xvf /opt/apache-tomcat-7.0.61.tar.gz -C /opt/ creates=/opt/apache-tomcat-7.0.61

#- name: Symlink install directory
#  file: src=/opt/apache-tomcat-7.0.61 path=/usr/share/tomcat state=link

#- name: Change ownership of Tomcat installation
#  file: path=/usr/share/tomcat/ owner=tomcat group=tomcat state=directory recurse=yes

#- name: Configure Tomcat server
#  template: src=server.xml dest=/usr/share/tomcat/conf/

  
#- name: Create  sample directory
#  file: 
#    path: "/opt/apache-tomcat-7.0.61/webapps/samples"
#    state: directory
#    mode: 0777
#  become: true
  
#- name: Install Docker
#  apt:
#    name: docker-ce
#    state: present
    

- name: Install required system packages
  apt:
        pkg:
          #- apt-transport-https
          #- ca-certificates
          #- curl
          #- software-properties-common
          - python3-pip
          - virtualenv
          - python3-setuptools
        state: latest
        update_cache: true

- name: Install Python
  apt:
    name: "python3"
    state: present

- name: Add Docker GPG apt Key
  apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

- name: Add Docker Repository
  apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu focal stable
        state: present

- name: Update apt and install docker-ce
  apt:
        name: docker-ce
        state: latest
        update_cache: true

- name: Install Docker Module for Python
  pip:
        name: docker

#- name: Install Docker sdk for python
#  pip:
#    name: docker
    
- name: Start Docker service
  service:
    name: "docker"
    state: started
    
- name: webpage directory
  file:
    state: directory
    dest: "/root/webpage"
    
#- name: Pull httpd docker image
#  docker_image:
#    name: httpd
#    tag: latest
#    source: pull
    
- name: Pull httpd docker image
  docker_image:
    name: tomcat
    tag: latest
    source: pull

- name: Copy website to the host
  copy:
    src: /var/lib/jenkins/workspace/jenkins_ci/project/target/LoginWebApp-1.war
    dest: /root/webpage
    
#- name: copy war file
#  copy: src=./target/LoginWebApp-1.war dest=/opt/apache-tomcat-7.0.61/webapps/

- name: Run docker container
  docker_container:
      name: WebServer
      image: tomcat:latest
      state: started
      exposed_ports:
      - "8080"
      ports:
      - "8080:8080"
      volumes:
      - /root/webpage/:/usr/local/tomcat/webapps/
      
      
#  notify: restart tomcat

#- name: Install Tomcat init script
#  copy: src=tomcat-initscript.sh dest=/etc/init.d/tomcat mode=0755

#- name: Start Tomcat
#  service: name=tomcat state=started enabled=yes

#- name: wait for tomcat to start
#  wait_for: port={{http_port}}
